# AI å‡½æ•°æ”¹è¿›åˆ†æ - ä¸­æ–‡æ€»ç»“

## ğŸ“Š æ–‡ä»¶æ¦‚å†µ

**æ–‡ä»¶**: `/Users/meaqua/Desktop/EE3070/smart-cat-backend/src/ai.ts`
- **æ€»è¡Œæ•°**: 2,882 è¡Œ
- **å¤æ‚åº¦**: å¾ˆé«˜ âš ï¸
- **æ”¹è¿›æ½œåŠ›**: å¾ˆå¤§ âœ¨

---

## ğŸ”´ 11 ä¸ªä¸»è¦æ”¹è¿›é¢†åŸŸ

### 1ï¸âƒ£ ç¯å¢ƒå˜é‡é…ç½®ç®¡ç† (ç¬¬ 60-320 è¡Œ)

**é—®é¢˜**:
- âŒ æœ‰ 50+ ä¸ªç¯å¢ƒå˜é‡ç›´æ¥åœ¨ä»£ç ä¸­è§£æ
- âŒ æ¯ä¸ªéƒ½é‡å¤ç›¸ä¼¼çš„æ¨¡å¼ï¼ˆIIFE ç«‹å³æ‰§è¡Œå‡½æ•°ï¼‰
- âŒ é…ç½®æ•£è½åœ¨æ•´ä¸ªæ–‡ä»¶ä¸­
- âŒ å¾ˆéš¾ç»´æŠ¤å’ŒéªŒè¯

**æ”¹è¿›æ–¹æ¡ˆ**:
```typescript
// âœ… åˆ›å»ºä¸“é—¨çš„é…ç½®ç®¡ç†å™¨
class ConfigManager {
  chatModel: ChatModelConfig
  visionModel: VisionModelConfig
  proModel: ProModelConfig
  retry: RetryConfig
}

// ä¼˜ç‚¹:
// - æ‰€æœ‰é…ç½®åœ¨ä¸€å¤„
// - é›†ä¸­éªŒè¯
// - æ˜“äºå•å…ƒæµ‹è¯•
// - æ˜“äºæ–‡æ¡£åŒ–
```

**é¢„è®¡ä»£ç å‡å°‘**: 260 è¡Œ â†’ 100 è¡Œ

---

### 2ï¸âƒ£ æ„å›¾æ£€æµ‹å‡½æ•°é‡å¤ (ç¬¬ 349-486 è¡Œ, ç¬¬ 2196-2209 è¡Œ)

**é—®é¢˜**:
- âŒ 5 ä¸ªç›¸ä¼¼çš„æ„å›¾æ£€æµ‹å‡½æ•°
  - `detectSettingsIntent`
  - `detectCalibrationIntent`
  - `detectMemorySaveIntent`
  - `detectTaskCreationIntent`
  - `detectManualModelPreference`
- âŒ ä»£ç é‡å¤ 30-40%
- âŒ å¾ˆéš¾ç»´æŠ¤å’Œæ‰©å±•
- âŒ ä¸ä¸€è‡´çš„ç½®ä¿¡åº¦è¯„åˆ†

**æ”¹è¿›æ–¹æ¡ˆ**:
```typescript
// âœ… åˆ›å»ºé€šç”¨æ„å›¾æ£€æµ‹æ¡†æ¶
class IntentDetector {
  detect<T>(text: string, intentName: string): {
    intent: T | null
    confidence: number
    reasoning?: string
  }
}

// ä½¿ç”¨:
const detector = new IntentDetector()
const result = detector.detect<SettingsIntent>(question, 'updateSettings')
```

**é¢„è®¡ä»£ç å‡å°‘**: 400 è¡Œ â†’ 200 è¡Œ (50% å‰Šå‡)

---

### 3ï¸âƒ£ æç¤ºè¯æ„å»ºå¤æ‚åº¦ (ç¬¬ 1430-1831 è¡Œ)

**é—®é¢˜**:
- âŒ `buildPromptContent()` å‡½æ•° 400+ è¡Œï¼
- âŒ æ··åˆ 6 ä¸ªä¸åŒçš„èŒè´£ï¼š
  1. å†³å®šåŒ…å«å“ªäº›ä¿¡æ¯
  2. æ ¼å¼åŒ–ä¼ æ„Ÿå™¨æ•°æ®
  3. æ„å»ºå†å²æ€»ç»“
  4. æå–è§è§£
  5. é€‰æ‹©æç¤ºè¯ç­–ç•¥
  6. æ•´åˆå„ç§ä¸Šä¸‹æ–‡
- âŒ è¿”å›å¯¹è±¡æœ‰ 18 ä¸ªå­—æ®µ
- âŒ å¾ˆéš¾ç†è§£å’Œä¿®æ”¹

**æ”¹è¿›æ–¹æ¡ˆ**:
```typescript
// âœ… ä½¿ç”¨ Builder æ¨¡å¼
const builder = new PromptBuilder(language)
  .addSummary(snapshot)
  .addInsights(insights)
  .addHistory(history)
  .addMemories(memories)
  .addVisionAnalysis(visionText)

const prompt = builder.build()
```

**ä¼˜ç‚¹**:
- âœ… æ¯ä¸ªéƒ¨åˆ†ç‹¬ç«‹
- âœ… æ˜“äºæ·»åŠ æ–°çš„ä¸Šä¸‹æ–‡ç±»å‹
- âœ… çµæ´»çš„ä¼˜å…ˆçº§æ§åˆ¶
- âœ… æ˜“äºå•å…ƒæµ‹è¯•

---

### 4ï¸âƒ£ ç¡¬ç¼–ç çš„æ¨¡å¼å’Œå­—ç¬¦ä¸² (æ•£å¸ƒåœ¨æ•´ä¸ªæ–‡ä»¶ä¸­)

**é—®é¢˜**:
- âŒ 100+ ä¸ªç¡¬ç¼–ç çš„æ­£åˆ™è¡¨è¾¾å¼å’Œå…³é”®å­—
- âŒ åˆ†æ•£åœ¨å¤šå¤„
- âŒ éš¾ä»¥æŸ¥çœ‹å…¨éƒ¨æ”¯æŒçš„æ¨¡å¼
- âŒ éš¾ä»¥æ›´æ–°å’Œç»´æŠ¤

**æ”¹è¿›æ–¹æ¡ˆ**:
```typescript
// âœ… åˆ›å»ºç»Ÿä¸€çš„æ¨¡å¼åº“
export const PATTERNS = {
  settings: {
    verbs: { english: [...], chinese: [...] },
    temperature: /...regex.../i,
    humidity: /...regex.../i,
  },
  calibration: { ... },
  memory: { ... },
  proMode: { ... },
}

// ä¼˜ç‚¹:
// - é›†ä¸­ç®¡ç†
// - æ˜“äºæ‰©å±•
// - æ˜“äºå›½é™…åŒ–
```

---

### 5ï¸âƒ£ æœ¬åœ°æ¨¡å‹è°ƒç”¨é€»è¾‘ (ç¬¬ 2243-2535 è¡Œ)

**é—®é¢˜**:
- âŒ `callLocalModel()` å‡½æ•° 300+ è¡Œ
- âŒ æ··åˆ 5 ä¸ªèŒè´£ï¼š
  1. é…ç½®ç®¡ç†
  2. HTTP è¯·æ±‚
  3. é‡è¯•é€»è¾‘
  4. å­è¿›ç¨‹ç®¡ç†
  5. é”™è¯¯å¤„ç†
- âŒ é‡è¯•é€»è¾‘å¤æ‚ (80 è¡Œ)
- âŒ å­è¿›ç¨‹ç®¡ç†å¤æ‚ (150 è¡Œ)
- âŒ éš¾ä»¥å•å…ƒæµ‹è¯•

**æ”¹è¿›æ–¹æ¡ˆ**:
```typescript
// âœ… åˆ†è§£æˆä¸“é—¨çš„ç±»
class RetryableHttpClient { ... }
class ModelClient { ... }
class ModelOrchestrator { ... }

// è°ƒç”¨:
const result = await orchestrator.call(messages, config)
```

**é¢„è®¡ä»£ç **:
- åŸæ¥: 300 è¡Œæ··ä¹±
- æ”¹è¿›: 100 + 100 + 100 = 300 è¡Œï¼ˆä½†æ¸…æ™°ï¼‰

---

### 6ï¸âƒ£ å›¾åƒå¤„ç†é€»è¾‘ (ç¬¬ 700-1018 è¡Œ)

**é—®é¢˜**:
- âŒ `analyzeImageWithQwen()` æµç¨‹æ›¾è¿‡åº¦å¤æ‚ï¼Œä»éœ€è¦æŠ½ç¦»ä¸ºå¯å¤ç”¨æ¨¡å—
- âŒ å›¾åƒå¤„ç†ç»†èŠ‚æ•£è½åœ¨ä»£ç ä¸­
- âŒ Base64 å¤„ç†æœ‰å¤šä¸ªåœ°æ–¹
- âŒ é”™è¯¯å¤„ç†å¯ä»¥æ›´ç»“æ„åŒ–

**æ”¹è¿›æ–¹æ¡ˆ**:
```typescript
// âœ… ä¸“é—¨çš„å›¾åƒå¤„ç†æ¨¡å—
class ImageProcessor {
  async resolveImageData(...): Promise<{ data: string; mimeType: string }>
  async analyzeWithVision(...): Promise<string>
}
```

---

### 7ï¸âƒ£ ç³»ç»Ÿæç¤ºè¯ç®¡ç† (ç¬¬ 2539-2567 è¡Œ)

**é—®é¢˜**:
- âŒ `buildSystemPrompt()` å¾ˆå¤æ‚
- âŒ å¾ˆå¤šç¡¬ç¼–ç çš„æ–‡æœ¬
- âŒ éš¾ä»¥ç»´æŠ¤å¤šè¯­è¨€
- âŒ éš¾ä»¥ A/B æµ‹è¯•

**æ”¹è¿›æ–¹æ¡ˆ**:
```typescript
// âœ… Prompt æ¨¡æ¿ç³»ç»Ÿ
class PromptTemplate {
  register(name: string, language: LanguageCode, content: string)
  get(name: string, language: LanguageCode): string
  render(name: string, language: LanguageCode, vars: Record<string, any>): string
}
```

---

### 8ï¸âƒ£ èŠå¤©å†å²å¤„ç† (ç¬¬ 1232-1310 è¡Œ)

**é—®é¢˜**:
- âŒ `limitConversationContext()` é€»è¾‘ä¸æ¸…æ™°
- âŒ `estimateTokenCount()` åªæ˜¯å¯å‘å¼
- âŒ æ²¡æœ‰ç¼“å­˜ token è®¡æ•°
- âŒ å†å²æˆªæ–­å¯èƒ½ä¸¢å¤±é‡è¦ä¿¡æ¯

**æ”¹è¿›æ–¹æ¡ˆ**:
```typescript
// âœ… æ”¹è¿›çš„å†å²ç®¡ç†å™¨
class ConversationHistoryManager {
  estimateTokens(text: string, language: LanguageCode): number
  limitContext(messages: ChatMessage[], maxTokens: number): ChatMessage[]
}
```

---

### 9ï¸âƒ£ é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½• (æ•£å¸ƒåœ¨æ•´ä¸ªæ–‡ä»¶)

**é—®é¢˜**:
- âŒ é”™è¯¯å¤„ç†åˆ†æ•£
- âŒ é”™è¯¯æ¶ˆæ¯ä¸ä¸€è‡´
- âŒ æ—¥å¿—è®°å½•æ–¹å¼ä¸ç»Ÿä¸€
- âŒ æ²¡æœ‰ç»“æ„åŒ–çš„é”™è¯¯ç±»

**æ”¹è¿›æ–¹æ¡ˆ**:
```typescript
// âœ… ç»Ÿä¸€çš„é”™è¯¯å’Œæ—¥å¿—ç³»ç»Ÿ
class AIError extends Error {
  constructor(message: string, code: string, retryable: boolean)
}

class Logger {
  debug(context: string, message: string, data?: any)
  warn(context: string, message: string, data?: any)
  error(context: string, error: Error | string, data?: any)
}
```

---

### ğŸ”Ÿ æ€§èƒ½ä¼˜åŒ–

**é—®é¢˜**:
- âŒ æ²¡æœ‰ç¼“å­˜æœºåˆ¶
- âŒ æŸäº›è®¡ç®—é‡å¤æ‰§è¡Œ
- âŒ æ­£åˆ™è¡¨è¾¾å¼å¯èƒ½é‡å¤ç¼–è¯‘

**æ”¹è¿›æ–¹æ¡ˆ**:
```typescript
// âœ… æ·»åŠ ç¼“å­˜
class CachedFormatter {
  formatSummary(snapshot, language): string {
    const key = `${snapshot.timestamp}-${language}`
    const cached = this.cache.get(key)
    if (cached) return cached
    // ... è®¡ç®— ...
  }
}
```

**é¢„æœŸæ€§èƒ½æå‡**: 20-30% å‡å°‘è®¡ç®—

---

### 1ï¸âƒ£1ï¸âƒ£ å•å…ƒæµ‹è¯•å‹å¥½æ€§

**é—®é¢˜**:
- âŒ `generateChatContent()` å¾ˆéš¾æµ‹è¯•
- âŒ æ²¡æœ‰ä¾èµ–æ³¨å…¥
- âŒ ç¡¬ç¼–ç çš„å…¨å±€çŠ¶æ€

**æ”¹è¿›æ–¹æ¡ˆ**:
```typescript
// âœ… ä½¿ç”¨ä¾èµ–æ³¨å…¥
class AIService {
  constructor(
    private modelClient: ModelClient,
    private imageProcessor: ImageProcessor,
    private promptBuilder: PromptBuilder,
    private config: AIConfig
  ) {}
}

// æµ‹è¯•:
const service = new AIService(mockModel, mockImage, ...)
```

---

## ğŸ“ˆ æ”¹è¿›ä¼˜å…ˆçº§å’Œæ—¶é—´è¡¨

### ğŸ”´ ç¬¬ä¸€é˜¶æ®µ (1-2 å‘¨) - ç«‹å³æ‰§è¡Œ

| ä¼˜å…ˆçº§ | ä»»åŠ¡ | ä»£ç è¡Œæ•° | æ—¶é—´ | æ”¶ç›Š |
|------|------|--------|------|------|
| 1 | ConfigManager | 260 â†’ 100 | 2-3 å¤© | 50% é…ç½®ä»£ç ç®€åŒ– |
| 2 | æ¨¡å¼åº“ | 100 è¡Œ | 1-2 å¤© | é›†ä¸­ç®¡ç† |
| 3 | é”™è¯¯å¤„ç† | 50 è¡Œ | 1 å¤© | ç»Ÿä¸€é”™è¯¯ |

### ğŸŸ  ç¬¬äºŒé˜¶æ®µ (2-4 å‘¨)

| ä¼˜å…ˆçº§ | ä»»åŠ¡ | ä»£ç è¡Œæ•° | æ—¶é—´ | æ”¶ç›Š |
|------|------|--------|------|------|
| 4 | IntentDetector | 400 â†’ 200 | 3-4 å¤© | ä»£ç é‡ç”¨ 50% |
| 5 | PromptBuilder | 400 â†’ 250 | 3-4 å¤© | ç®€åŒ–é€»è¾‘ |
| 6 | æ—¥å¿—ç³»ç»Ÿ | 100 è¡Œ | 1-2 å¤© | ç»Ÿä¸€æ—¥å¿— |

### ğŸŸ¢ ç¬¬ä¸‰é˜¶æ®µ (1-2 ä¸ªæœˆ)

| ä¼˜å…ˆçº§ | ä»»åŠ¡ | ä»£ç è¡Œæ•° | æ—¶é—´ | æ”¶ç›Š |
|------|------|--------|------|------|
| 7 | ModelOrchestrator | 300 â†’ 300 | 5-7 å¤© | æ¸…æ™°æ¶æ„ |
| 8 | ImageProcessor | 300 â†’ 150 | 2-3 å¤© | èŒè´£æ¸…æ™° |
| 9 | ç¼“å­˜ç³»ç»Ÿ | 100 è¡Œ | 2-3 å¤© | 20-30% æ€§èƒ½æå‡ |
| 10 | å•å…ƒæµ‹è¯• | 500+ è¡Œ | 1-2 å‘¨ | å¯æµ‹è¯•æ€§ 8/10 |

---

## ğŸ“Š ä»£ç æ”¹è¿›å¯¹æ¯”

### åŸå§‹ ai.ts ç»“æ„
```
ai.ts (2,882 è¡Œ)
â”œâ”€â”€ ç¯å¢ƒå˜é‡é…ç½® (260 è¡Œ)
â”œâ”€â”€ æ„å›¾æ£€æµ‹ (400 è¡Œ)
â”œâ”€â”€ æç¤ºè¯æ„å»º (400 è¡Œ)
â”œâ”€â”€ å›¾åƒå¤„ç† (300 è¡Œ)
â”œâ”€â”€ æ¨¡å‹è°ƒç”¨ (300 è¡Œ)
â””â”€â”€ å…¶ä»– (1,222 è¡Œ)
```

### æ”¹è¿›åé¢„æœŸç»“æ„
```
ai/ (æ€»è®¡ 2,800-3,200 è¡Œï¼Œæ›´æ¸…æ™°)
â”œâ”€â”€ ai.ts (æ ¸å¿ƒï¼Œ800-1,000 è¡Œ)
â”œâ”€â”€ config.ts (200-300 è¡Œ)
â”œâ”€â”€ patterns.ts (200-300 è¡Œ)
â”œâ”€â”€ intent-detector.ts (200-250 è¡Œ)
â”œâ”€â”€ model-client.ts (250-350 è¡Œ)
â”œâ”€â”€ prompt-builder.ts (200-250 è¡Œ)
â”œâ”€â”€ image-processor.ts (150-200 è¡Œ)
â”œâ”€â”€ history-manager.ts (150-200 è¡Œ)
â”œâ”€â”€ logger.ts (100-150 è¡Œ)
â”œâ”€â”€ errors.ts (100 è¡Œ)
â””â”€â”€ cache.ts (100-150 è¡Œ)
```

---

## âœ¨ é¢„æœŸæ”¹è¿›æ•ˆæœ

### ä»£ç è´¨é‡æŒ‡æ ‡

| æŒ‡æ ‡ | åŸæ¥ | æ”¹è¿›å | æå‡ |
|------|------|--------|------|
| å¯è¯»æ€§ | 6/10 | 8.5/10 | +42% |
| å¯ç»´æŠ¤æ€§ | 5/10 | 8/10 | +60% |
| å¯æµ‹è¯•æ€§ | 3/10 | 8/10 | +167% |
| å¯æ‰©å±•æ€§ | 4/10 | 8.5/10 | +112% |

### å¼€å‘æ•ˆç‡

| ä»»åŠ¡ | åŸæ¥ | æ”¹è¿›å | åŠ é€Ÿ |
|------|------|--------|------|
| æ·»åŠ æ–°æ„å›¾ | 1 å°æ—¶ | 10 åˆ†é’Ÿ | 6 å€ |
| ä¿®å¤ bug | éš¾ä»¥å®šä½ | å¿«é€Ÿå®šä½ | ++ |
| å•å…ƒæµ‹è¯• | å›°éš¾ | ç®€å• | ++ |
| ä»£ç å®¡æŸ¥ | å›°éš¾ | ç®€å• | ++ |

### æ€§èƒ½æ”¹è¿›

- ç¼“å­˜åå‡å°‘ 20-30% çš„é‡å¤è®¡ç®—
- æ”¹è¿›çš„å†å²ç®¡ç†å‡å°‘ token æµªè´¹
- æ›´å¥½çš„èµ„æºåˆ©ç”¨

---

## ğŸš€ ç«‹å³å¯å®æ–½çš„æ”¹è¿›

### æœ€å¿«è§æ•ˆ (ä»Šå¤©å°±å¯ä»¥å¼€å§‹)

1. **æå–ç¡¬ç¼–ç å­—ç¬¦ä¸²** (1-2 å°æ—¶)
   - åˆ›å»º `patterns.ts`
   - æå–æ‰€æœ‰çš„ `MEMORY_SAVE_TRIGGERS`, `SETTING_VERBS_EN` ç­‰

2. **åˆ›å»ºé…ç½®ç®¡ç†å™¨** (2-3 å°æ—¶)
   - æ•´ç†ç¯å¢ƒå˜é‡è§£æé€»è¾‘
   - åˆ›å»º `config.ts`

3. **æ”¹è¿›é”™è¯¯å¤„ç†** (1-2 å°æ—¶)
   - åˆ›å»º `AIError` ç±»
   - åˆ›å»ºç»“æ„åŒ–çš„é”™è¯¯å¤„ç†

### é¢„è®¡æ”¶ç›Š

- ä»£ç æ›´æ¸…æ™°
- æ›´å®¹æ˜“ç»´æŠ¤
- ä¸ºåç»­é‡æ„åšå‡†å¤‡

---

## ğŸ“ å»ºè®®å®æ–½é¡ºåº

1. **ç¬¬ 1 å¤©**: åˆ›å»ºæ¨¡å¼åº“ (PATTERNS)
2. **ç¬¬ 2 å¤©**: åˆ›å»ºé…ç½®ç®¡ç†å™¨ (ConfigManager)
3. **ç¬¬ 3 å¤©**: æ”¹è¿›é”™è¯¯å¤„ç† (AIError + Logger)
4. **ç¬¬ 4-7 å¤©**: åˆ›å»ºæ„å›¾æ£€æµ‹æ¡†æ¶ (IntentDetector)
5. **ç¬¬ 8-10 å¤©**: åˆ›å»ºæç¤ºè¯æ„å»ºå™¨ (PromptBuilder)
6. **ç¬¬ 11-14 å¤©**: é‡æ„æ¨¡å‹è°ƒç”¨ (ModelOrchestrator)
7. **ç¬¬ 15+ å¤©**: æ·»åŠ ç¼“å­˜ã€å•å…ƒæµ‹è¯•

---

## ğŸ’¡ å…³é”®æ”¹è¿›ç‚¹æ€»ç»“

1. âœ… **é…ç½®é›†ä¸­åŒ–** - ä» 260 è¡Œ IIFE åˆ° 1 ä¸ª ConfigManager
2. âœ… **æ„å›¾æ£€æµ‹ç»Ÿä¸€** - ä» 5 ä¸ªé‡å¤å‡½æ•°åˆ° 1 ä¸ª IntentDetector
3. âœ… **æç¤ºè¯æ„å»º** - ä» 400 è¡Œæ··ä¹±åˆ° Builder æ¨¡å¼
4. âœ… **æ¨¡å¼åº“** - ä» 100+ ä¸ªç¡¬ç¼–ç åˆ°é›†ä¸­ç®¡ç†
5. âœ… **æ¨¡å‹è°ƒç”¨åˆ†è§£** - ä» 300 è¡Œæ··åˆåˆ° 3 ä¸ªä¸“é—¨çš„ç±»
6. âœ… **é”™è¯¯å¤„ç†ç»Ÿä¸€** - ä»åˆ†æ•£çš„ try-catch åˆ°ç»“æ„åŒ–çš„é”™è¯¯
7. âœ… **æ—¥å¿—ç³»ç»Ÿ** - ä»æ··ä¹±çš„æ—¥å¿—åˆ°ç»Ÿä¸€çš„ Logger
8. âœ… **ç¼“å­˜æœºåˆ¶** - ä»æ— ç¼“å­˜åˆ°æ™ºèƒ½ç¼“å­˜
9. âœ… **å•å…ƒæµ‹è¯•** - ä»éš¾ä»¥æµ‹è¯•åˆ°æ˜“äºæµ‹è¯•
10. âœ… **æ€§èƒ½ä¼˜åŒ–** - ä» O(n) é‡å¤åˆ°ç¼“å­˜ä¼˜åŒ–

---

## ğŸ¯ é¢„æœŸæœ€ç»ˆç»“æœ

- **ä»£ç è´¨é‡**: ä» 6.5/10 â†’ 8.5/10
- **å¯ç»´æŠ¤æ€§**: æ˜¾è‘—æå‡
- **å¼€å‘é€Ÿåº¦**: æå‡ 3-5 å€
- **Bug æ•°é‡**: å‡å°‘ 30-40%
- **æµ‹è¯•è¦†ç›–**: ä» <20% â†’ >80%
