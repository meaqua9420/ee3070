# ğŸ‰ AI åŠŸèƒ½æ•´åˆå®Œæˆå ±å‘Š

## âœ… å·²å®Œæˆçš„å¾Œç«¯æ•´åˆ

### 1. Import æ¨¡çµ„ (index.ts:124-129)
```typescript
import * as knowledgeExtractor from './knowledgeExtractor.js'
import * as proactiveAssistant from './proactiveAssistant.js'
import * as fileHandler from './fileHandler.js'
import { analyzePDF, generatePDFSummary } from './pdfParser.js'
import { analyzeAudioWithAI, generateAudioSummary } from './audioAnalyzer.js'
import { analyzeVideoWithAI, generateVideoSummary } from './videoProcessor.js'
```

### 2. API ç«¯é»å·²æ·»åŠ  (index.ts:4848-5017)
âœ… **çŸ¥è­˜æå– API** (5 å€‹ç«¯é»):
- `POST /api/knowledge/extract` - AI æå–çŸ¥è­˜
- `GET /api/knowledge` - ç²å–çŸ¥è­˜åˆ—è¡¨
- `PATCH /api/knowledge/:id` - æ›´æ–°çŸ¥è­˜
- `DELETE /api/knowledge/:id` - åˆªé™¤çŸ¥è­˜
- `GET /api/knowledge/stats` - çŸ¥è­˜çµ±è¨ˆ

âœ… **ä¸»å‹•æ´å¯Ÿ API** (3 å€‹ç«¯é»):
- `GET /api/insights` - ç²å–æ´»èºæ´å¯Ÿ
- `POST /api/insights/check` - æ‰‹å‹•æª¢æŸ¥æ´å¯Ÿ
- `POST /api/insights/:id/dismiss` - æ¨™è¨˜ç‚ºå·²è®€

### 3. åˆå§‹åŒ–ä»£ç¢¼å·²æ·»åŠ  (index.ts:7389-7398)
```typescript
// ğŸ“ Initialize file upload directories
fileHandler.ensureUploadDir().then(() => {
  console.log('[files] Upload directories initialized')
})

// ğŸ’¡ Start proactive assistant
proactiveAssistant.startProactiveAssistant()
console.log('[proactive] Assistant started (checking every 15 minutes)')
```

---

## ğŸ“ å‰ç«¯æ•´åˆæ­¥é©Ÿ

### æ­¥é©Ÿ 1: æ•´åˆ API å‡½æ•¸åˆ° backendClient.ts

**æ–¹æ³• A: ç›´æ¥è¿½åŠ åˆ°æ–‡ä»¶æœ«å°¾**

åœ¨ `/Users/meaqua/Desktop/EE3070/smart-cat-home/src/utils/backendClient.ts` çš„æœ€å¾Œä¸€è¡Œä¹‹å¾Œæ·»åŠ :

```typescript
// ==================== çŸ¥è­˜æå– API ====================

export type KnowledgeType = 'fact' | 'habit' | 'health' | 'preference' | 'event'

export interface KnowledgeItem {
  id: string
  type: KnowledgeType
  content: string
  confidence: number
  importance: 'low' | 'medium' | 'high'
  tags: string[]
  relatedDate?: string
  createdAt: string
  source: string
  catId?: string
}

export async function fetchKnowledge(catId?: string, limit?: number) {
  const params = new URLSearchParams()
  if (catId) params.append('catId', catId)
  if (limit) params.append('limit', limit.toString())

  const response = await fetch(`${API_BASE_URL}/api/knowledge?${params}`, {
    method: 'GET',
    credentials: 'include',
  })

  if (!response.ok) {
    throw new Error('Failed to fetch knowledge')
  }

  const result = await response.json()
  return result.knowledge || []
}

export async function updateKnowledge(id: string, updates: any) {
  const response = await fetch(`${API_BASE_URL}/api/knowledge/${id}`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify(updates),
  })

  if (!response.ok) {
    throw new Error('Failed to update knowledge')
  }

  return response.json()
}

export async function deleteKnowledge(id: string) {
  const response = await fetch(`${API_BASE_URL}/api/knowledge/${id}`, {
    method: 'DELETE',
    credentials: 'include',
  })

  if (!response.ok) {
    throw new Error('Failed to delete knowledge')
  }

  return response.json()
}

// ==================== ä¸»å‹•æ´å¯Ÿ API ====================

export type InsightPriority = 'low' | 'medium' | 'high' | 'critical'
export type InsightCategory = 'hydration' | 'nutrition' | 'environment' | 'activity' | 'health' | 'maintenance'

export interface ProactiveInsight {
  id: string
  category: InsightCategory
  priority: InsightPriority
  title: string
  message: string
  recommendation: string[]
  relatedData?: any
  catId?: string
  createdAt: string
  expiresAt?: string
}

export async function fetchInsights(catId?: string) {
  const params = new URLSearchParams()
  if (catId) params.append('catId', catId)

  const response = await fetch(`${API_BASE_URL}/api/insights?${params}`, {
    method: 'GET',
    credentials: 'include',
  })

  if (!response.ok) {
    throw new Error('Failed to fetch insights')
  }

  const result = await response.json()
  return result.insights || []
}

export async function dismissInsight(id: string) {
  const response = await fetch(`${API_BASE_URL}/api/insights/${id}/dismiss`, {
    method: 'POST',
    credentials: 'include',
  })

  if (!response.ok) {
    throw new Error('Failed to dismiss insight')
  }

  return response.json()
}
```

**æ–¹æ³• B: ä½¿ç”¨æ“´å±•æ–‡ä»¶**

å¦‚æœä¸æƒ³ä¿®æ”¹åŸå§‹æ–‡ä»¶,å¯ä»¥ä½¿ç”¨å·²å‰µå»ºçš„ `backendClientExtensions.ts`,ç„¶å¾Œåœ¨éœ€è¦çš„åœ°æ–¹ import:

```typescript
import { fetchKnowledge, updateKnowledge, deleteKnowledge, fetchInsights, dismissInsight } from '../utils/backendClientExtensions'
```

---

### æ­¥é©Ÿ 2: åœ¨ AiChatPanel ä¸­æ•´åˆçµ„ä»¶

æ‰¾åˆ° `/Users/meaqua/Desktop/EE3070/smart-cat-home/src/components/AiChatPanel.tsx`,æ·»åŠ ä»¥ä¸‹å…§å®¹:

#### 2.1 Import çµ„ä»¶å’Œ API
```typescript
import React, { useState, useEffect } from 'react'
import ContextVisualization from './ContextVisualization'
import KnowledgeCards from './KnowledgeCards'
import ProactiveInsights from './ProactiveInsights'
import { fetchKnowledge, updateKnowledge, deleteKnowledge, fetchInsights, dismissInsight } from '../utils/backendClient'
```

#### 2.2 æ·»åŠ ç‹€æ…‹ç®¡ç†
```typescript
// åœ¨ AiChatPanel å‡½æ•¸å…§éƒ¨æ·»åŠ 
const [knowledge, setKnowledge] = useState([])
const [insights, setInsights] = useState([])
const [contextSources, setContextSources] = useState([])
```

#### 2.3 æ·»åŠ æ•¸æ“šè¼‰å…¥å‡½æ•¸
```typescript
// è¼‰å…¥çŸ¥è­˜
const loadKnowledge = async () => {
  try {
    const result = await fetchKnowledge(selectedCatId, 50)
    setKnowledge(result.map(k => ({
      ...k,
      createdAt: new Date(k.createdAt)
    })))
  } catch (error) {
    console.error('Failed to load knowledge:', error)
  }
}

// è¼‰å…¥æ´å¯Ÿ
const loadInsights = async () => {
  try {
    const result = await fetchInsights(selectedCatId)
    setInsights(result.map(i => ({
      ...i,
      createdAt: new Date(i.createdAt),
      expiresAt: i.expiresAt ? new Date(i.expiresAt) : undefined
    })))
  } catch (error) {
    console.error('Failed to load insights:', error)
  }
}

// ä½¿ç”¨ useEffect è¼‰å…¥æ•¸æ“š
useEffect(() => {
  loadKnowledge()
  loadInsights()

  // å®šæœŸæ›´æ–°æ´å¯Ÿ
  const interval = setInterval(loadInsights, 60000) // æ¯åˆ†é˜
  return () => clearInterval(interval)
}, [selectedCatId])
```

#### 2.4 æ·»åŠ è™•ç†å‡½æ•¸
```typescript
const handleDismissInsight = async (id: string) => {
  try {
    await dismissInsight(id)
    setInsights(prev => prev.filter(i => i.id !== id))
  } catch (error) {
    console.error('Failed to dismiss insight:', error)
  }
}

const handleEditKnowledge = async (id: string, updates: any) => {
  try {
    await updateKnowledge(id, updates)
    await loadKnowledge()
  } catch (error) {
    console.error('Failed to update knowledge:', error)
  }
}

const handleDeleteKnowledge = async (id: string) => {
  try {
    await deleteKnowledge(id)
    setKnowledge(prev => prev.filter(k => k.id !== id))
  } catch (error) {
    console.error('Failed to delete knowledge:', error)
  }
}
```

#### 2.5 åœ¨ JSX ä¸­æ·»åŠ çµ„ä»¶
```typescript
return (
  <div className="ai-chat-panel">
    {/* ä¸»å‹•æ´å¯Ÿ (å›ºå®šåœ¨é ‚éƒ¨) */}
    <ProactiveInsights
      insights={insights}
      onDismiss={handleDismissInsight}
    />

    {/* ç¾æœ‰çš„èŠå¤©ç•Œé¢ */}
    <div className="chat-messages">
      {messages.map(msg => (
        <div key={msg.id}>
          {msg.content}

          {/* åœ¨ AI å›è¦†å¾Œé¡¯ç¤ºä¸Šä¸‹æ–‡ */}
          {msg.role === 'assistant' && msg.contextSources && (
            <ContextVisualization sources={msg.contextSources} />
          )}
        </div>
      ))}
    </div>

    {/* çŸ¥è­˜å¡ç‰‡ (å¯æ‘ºç–Šå€åŸŸ) */}
    <div className="knowledge-section">
      <button onClick={() => setShowKnowledge(!showKnowledge)}>
        {showKnowledge ? 'éš±è—' : 'é¡¯ç¤º'} çŸ¥è­˜å¡ç‰‡ ({knowledge.length})
      </button>

      {showKnowledge && (
        <KnowledgeCards
          knowledge={knowledge}
          onEdit={handleEditKnowledge}
          onDelete={handleDeleteKnowledge}
        />
      )}
    </div>
  </div>
)
```

---

## ğŸ¤ é¡å¤–åŠŸèƒ½å¯¦ä½œ

### åŠŸèƒ½ 1: PDF å°å‡ºçŸ¥è­˜å¡ç‰‡

å‰µå»º `/Users/meaqua/Desktop/EE3070/smart-cat-home/src/utils/exportKnowledge.ts`:

```typescript
import type { KnowledgeItem } from './backendClient'

export async function exportKnowledgeToPDF(knowledge: KnowledgeItem[], catName: string) {
  // ä½¿ç”¨ jsPDF åº« (éœ€è¦å®‰è£: npm install jspdf)
  // æˆ–è€…ä½¿ç”¨ç€è¦½å™¨çš„æ‰“å°åŠŸèƒ½

  const printWindow = window.open('', '', 'height=600,width=800')
  if (!printWindow) return

  const html = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>${catName} çš„çŸ¥è­˜å¡ç‰‡</title>
      <style>
        body { font-family: 'Noto Sans TC', sans-serif; padding: 20px; }
        h1 { color: #333; }
        .knowledge-item {
          border: 1px solid #ddd;
          padding: 15px;
          margin: 10px 0;
          border-radius: 8px;
        }
        .type { font-weight: bold; color: #2563eb; }
        .content { margin: 10px 0; }
        .meta { font-size: 0.9em; color: #666; }
        @media print {
          .no-print { display: none; }
        }
      </style>
    </head>
    <body>
      <h1>${catName} çš„çŸ¥è­˜å¡ç‰‡</h1>
      <p>ç”Ÿæˆæ™‚é–“: ${new Date().toLocaleString('zh-TW')}</p>
      <p>å…± ${knowledge.length} å€‹çŸ¥è­˜é»</p>

      ${knowledge.map((k, i) => `
        <div class="knowledge-item">
          <div class="type">${i + 1}. ${getTypeName(k.type)}</div>
          <div class="content">${k.content}</div>
          <div class="meta">
            ä¿¡å¿ƒåº¦: ${(k.confidence * 100).toFixed(0)}% |
            é‡è¦æ€§: ${k.importance} |
            æ¨™ç±¤: ${k.tags.join(', ')} |
            ${k.relatedDate || ''} |
            ${new Date(k.createdAt).toLocaleDateString('zh-TW')}
          </div>
        </div>
      `).join('')}

      <button class="no-print" onclick="window.print()">æ‰“å° / å­˜ç‚º PDF</button>
    </body>
    </html>
  `

  printWindow.document.write(html)
  printWindow.document.close()
}

function getTypeName(type: string): string {
  const names: Record<string, string> = {
    fact: 'ğŸ“Œ äº‹å¯¦',
    habit: 'ğŸ”„ ç¿’æ…£',
    health: 'ğŸ¥ å¥åº·',
    preference: 'â¤ï¸ åå¥½',
    event: 'ğŸ“… äº‹ä»¶'
  }
  return names[type] || type
}
```

åœ¨ KnowledgeCards çµ„ä»¶ä¸­æ·»åŠ å°å‡ºæŒ‰éˆ•:
```typescript
<button onClick={() => exportKnowledgeToPDF(knowledge, 'Mimi')}>
  ğŸ“„ å°å‡ºç‚º PDF
</button>
```

### åŠŸèƒ½ 2: ç·Šæ€¥é€šçŸ¥èªéŸ³æ’­å ±

åœ¨ ProactiveInsights çµ„ä»¶ä¸­æ·»åŠ èªéŸ³åŠŸèƒ½:

```typescript
// åœ¨çµ„ä»¶é ‚éƒ¨æ·»åŠ 
const playVoiceAlert = (insight: ProactiveInsight) => {
  if ('speechSynthesis' in window) {
    const utterance = new SpeechSynthesisUtterance(
      `ç·Šæ€¥é€šçŸ¥ï¼š${insight.title}ã€‚${insight.message}`
    )
    utterance.lang = 'zh-TW'
    utterance.rate = 1.0
    utterance.pitch = 1.0
    window.speechSynthesis.speak(utterance)
  }
}

// ä½¿ç”¨ useEffect è‡ªå‹•æ’­æ”¾ critical é€šçŸ¥
useEffect(() => {
  const criticalInsights = insights.filter(i => i.priority === 'critical')
  if (criticalInsights.length > 0 && !hasPlayedVoice.current) {
    playVoiceAlert(criticalInsights[0])
    hasPlayedVoice.current = true
  }
}, [insights])

// åœ¨æ©«å¹…ä¸­æ·»åŠ æ‰‹å‹•æ’­æ”¾æŒ‰éˆ•
<button onClick={() => playVoiceAlert(insight)} title="èªéŸ³æ’­å ±">
  ğŸ”Š
</button>
```

---

## ğŸ§ª å®Œæ•´æ¸¬è©¦æ­¥é©Ÿ

### 1. å•Ÿå‹•ä¸¦æ¸¬è©¦å¾Œç«¯

```bash
cd /Users/meaqua/Desktop/EE3070/smart-cat-backend
npm run build
npm start
```

æª¢æŸ¥æ—¥èªŒä¸­æ‡‰è©²çœ‹åˆ°:
```
[database] Migration 014_knowledge_extraction applied
[database] Migration 015_proactive_insights applied
[files] Upload directories initialized
[proactive] Assistant started (checking every 15 minutes)
```

### 2. æ¸¬è©¦ API ç«¯é»

```bash
# æ¸¬è©¦çŸ¥è­˜ API
curl http://localhost:4000/api/knowledge \
  -H "Cookie: sessionId=YOUR_SESSION_ID"

# æ¸¬è©¦æ´å¯Ÿ API
curl http://localhost:4000/api/insights \
  -H "Cookie: sessionId=YOUR_SESSION_ID"
```

### 3. å•Ÿå‹•ä¸¦æ¸¬è©¦å‰ç«¯

```bash
cd /Users/meaqua/Desktop/EE3070/smart-cat-home
npm run dev
```

æ¸¬è©¦åŠŸèƒ½:
- âœ… ç™»å…¥å¾ŒæŸ¥çœ‹ä¸»å‹•æ´å¯Ÿæ©«å¹…
- âœ… èˆ‡ AI å°è©±,è§€å¯ŸçŸ¥è­˜è‡ªå‹•æå–
- âœ… æŸ¥çœ‹çŸ¥è­˜å¡ç‰‡,ç·¨è¼¯å’Œåˆªé™¤
- âœ… æŸ¥çœ‹ä¸Šä¸‹æ–‡è¦–è¦ºåŒ–é¡¯ç¤º
- âœ… æ¸¬è©¦ PDF å°å‡ºåŠŸèƒ½
- âœ… æ¸¬è©¦èªéŸ³æ’­å ±åŠŸèƒ½

---

## âœ… å®Œæˆæª¢æŸ¥æ¸…å–®

### å¾Œç«¯æ•´åˆ
- [x] æ·»åŠ æ¨¡çµ„ imports
- [x] æ·»åŠ çŸ¥è­˜ API ç«¯é» (5å€‹)
- [x] æ·»åŠ æ´å¯Ÿ API ç«¯é» (3å€‹)
- [x] åˆå§‹åŒ–æª”æ¡ˆè™•ç†å™¨
- [x] å•Ÿå‹•ä¸»å‹•åŠ©ç†

### å‰ç«¯æ•´åˆ
- [ ] æ›´æ–° backendClient.ts æ·»åŠ  API å‡½æ•¸
- [ ] åœ¨ AiChatPanel ä¸­æ•´åˆçµ„ä»¶
- [ ] æ·»åŠ ç‹€æ…‹ç®¡ç†å’Œæ•¸æ“šè¼‰å…¥
- [ ] æ¸¬è©¦æ‰€æœ‰åŠŸèƒ½æ­£å¸¸é‹ä½œ

### é¡å¤–åŠŸèƒ½
- [ ] å¯¦ä½œ PDF å°å‡º
- [ ] å¯¦ä½œèªéŸ³æ’­å ±
- [ ] æ¸¬è©¦å°å‡ºå’ŒèªéŸ³åŠŸèƒ½

---

## ğŸ‰ æˆåŠŸæ¨™èªŒ

ç•¶æ‚¨å®Œæˆæ‰€æœ‰æ•´åˆå¾Œ,æ‡‰è©²èƒ½çœ‹åˆ°:

1. **å¾Œç«¯å•Ÿå‹•æ—¥èªŒ**:
   ```
   [files] Upload directories initialized
   [proactive] Assistant started (checking every 15 minutes)
   ```

2. **å‰ç«¯åŠŸèƒ½**:
   - é ‚éƒ¨é¡¯ç¤ºä¸»å‹•æ´å¯Ÿæ©«å¹… (å¦‚æœæœ‰ç·Šæ€¥é€šçŸ¥)
   - å°è©±ä¸‹æ–¹é¡¯ç¤ºä¸Šä¸‹æ–‡ä¾†æº
   - å´é‚Šæˆ–åº•éƒ¨é¡¯ç¤ºçŸ¥è­˜å¡ç‰‡
   - çŸ¥è­˜å¯ç·¨è¼¯ã€åˆªé™¤
   - å¯å°å‡ºç‚º PDF
   - ç·Šæ€¥é€šçŸ¥è‡ªå‹•èªéŸ³æ’­å ±

3. **æ•¸æ“šåº«è¡¨**:
   ```sql
   SELECT * FROM extracted_knowledge LIMIT 5;
   SELECT * FROM proactive_insights WHERE dismissed = 0;
   ```

---

**ğŸŠ æ­å–œï¼æ‚¨çš„ Smart Cat Home ç¾åœ¨æ“æœ‰å®Œæ•´çš„ AI å¢å¼·åŠŸèƒ½ï¼**
